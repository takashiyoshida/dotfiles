#!/usr/bin/env bash

function halp
{
    echo "`basename $0` -f <path to file> -s <servername> -p <prefix>"
    echo "    -f <compressed file: *.7z, *.zip>"
    echo "    -s <servername: i.e. wlhrtu1>"
    echo "    -p <prefix>"
    echo "       output will be saved in <prefix>-<servername>.csv"
    exit 0
}

while getopts f:s:p:h option
do
      case "${option}" in
          f) COMPFILE=${OPTARG};;
          s) SERVER=${OPTARG};;
          p) PREFIX=${OPTARG};;
          h) halp;;
      esac
done

if [ -z "${COMPFILE}" ]; then
    halp
fi
if [ -z "${SERVER}" ]; then
    halp
fi
if [ -z "${PREFIX}" ]; then
    halp
fi

#echo "COMPFILE = ${COMPFILE}"
#echo "SERVER   = ${SERVER}"
#echo "DATE     = ${DATE}"

filename=$(basename -- ${COMPFILE})
extension="${filename##*.}"

#echo "filename  = ${filename}"
#echo "extension = ${extension}"

OUTDIR=`mktemp -d`
#echo "OUTDIR = ${OUTDIR}"

if [ "${extension}" == "7z" ]; then
    7z e -o${OUTDIR}/out ${COMPFILE}
elif [ "${extension}" == "zip" ]; then
    unzip ${COMPFILE} -d ${OUTDIR}/out
else
    echo "Unexpected file extension: ${COMPFILE}"
    echo "Expected a *.7z or *.zip file"
    rm -rf ${OUTDIR}
    exit 1
fi

GZFILES=`find ${OUTDIR}/out -type f -name "*.gz"`
for f in ${GZFILES}; do
    gunzip ${f}
done

langoliers.py -l ${OUTDIR}/out/nelrtu.log* -n ${SERVER} -c ${PREFIX}-${SERVER}.csv -p 4
if [[ $? == 0 ]]; then
    rm -rf ${OUTDIR}
fi
